#!/bin/bash

set -e

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Source the dependency checker
source "$(dirname "$0")/claudefsd-check-dependencies"

# Function to display the menu
show_menu() {
    echo -e "${GREEN}ðŸ¤– Claude Full Self Drive (FSD) Tool${NC}"
    echo
    echo "This tool helps you manage development projects using AI agents."
    echo "Think of it as your AI-powered development team on autopilot!"
    echo
    echo "What would you like to do?"
    echo
    echo "  1) Development mode (default) - AI agents work on coding tasks"
    echo "  2) Analyze brief - Generate questions from project brief"
    echo "  3) Create plan - Generate requirements and plan from answered questions"
    echo "  4) Exit"
    echo
}

# Check dependencies first
check_dependencies

# If no arguments provided, show interactive menu
if [ $# -eq 0 ]; then
    show_menu
    read -p "Enter your choice [1]: " choice
    choice=${choice:-1}  # Default to 1 if empty
    
    case $choice in
        1)
            echo -e "${GREEN}Starting development mode...${NC}"
            echo
            exec "$(dirname "$0")/claudefsd-dev"
            ;;
        2)
            echo -e "${GREEN}Analyzing brief and generating questions...${NC}"
            echo
            "$(dirname "$0")/claudefsd-analyze-brief"
            
            if [ $? -eq 0 ]; then
                echo
                echo -e "${GREEN}Questions generated in docs/QUESTIONS.md${NC}"
                echo "Please answer the questions before proceeding."
                echo
                echo "What editor would you like to use?"
                echo "  1) nano (default)"
                echo "  2) vim"
                echo "  3) code (VS Code)"
                echo "  4) cursor"
                echo "  5) other"
                echo
                read -p "Enter your choice [1]: " editor_choice
                editor_choice=${editor_choice:-1}
                
                case $editor_choice in
                    1|"")
                        nano docs/QUESTIONS.md
                        ;;
                    2)
                        vim docs/QUESTIONS.md
                        ;;
                    3)
                        code docs/QUESTIONS.md
                        echo "Please answer the questions in VS Code, then press Enter to continue..."
                        read -n 1 -s
                        ;;
                    4)
                        cursor docs/QUESTIONS.md
                        echo "Please answer the questions in Cursor, then press Enter to continue..."
                        read -n 1 -s
                        ;;
                    5)
                        read -p "Enter editor command: " custom_editor
                        $custom_editor docs/QUESTIONS.md
                        echo "Please answer the questions, then press Enter to continue..."
                        read -n 1 -s
                        ;;
                    *)
                        echo -e "${RED}Invalid choice. Please edit docs/QUESTIONS.md manually and run option 3 when ready.${NC}"
                        exit 1
                        ;;
                esac
                
                echo
                echo -e "${GREEN}Now creating plan from answered questions...${NC}"
                echo
                exec "$(dirname "$0")/claudefsd-create-plan"
            fi
            ;;
        3)
            echo -e "${GREEN}Creating plan from answered questions...${NC}"
            echo
            exec "$(dirname "$0")/claudefsd-create-plan"
            ;;
        4)
            echo "Goodbye!"
            exit 0
            ;;
        *)
            echo -e "${RED}Invalid choice. Please run again.${NC}"
            exit 1
            ;;
    esac
else
    # If arguments provided, pass them through to the appropriate command
    case "$1" in
        dev)
            shift
            exec "$(dirname "$0")/claudefsd-dev" "$@"
            ;;
        analyze-brief)
            shift
            exec "$(dirname "$0")/claudefsd-analyze-brief" "$@"
            ;;
        create-plan)
            shift
            exec "$(dirname "$0")/claudefsd-create-plan" "$@"
            ;;
        *)
            echo -e "${RED}Unknown command: $1${NC}"
            echo
            echo "Usage: claudefsd [command]"
            echo
            echo "Commands:"
            echo "  dev           - Run development mode"
            echo "  analyze-brief - Analyze brief and generate questions"
            echo "  create-plan   - Create plan from answered questions"
            echo
            echo "Run without arguments for interactive mode."
            exit 1
            ;;
    esac
fi